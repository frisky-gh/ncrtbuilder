#!/usr/bin/perl

use strict;

$0 =~ m"^(.*)/";
our $TOOLHOME = "$1/..";
while( $TOOLHOME =~ s{(^|/)[^\.][^/]*/\.\.(/|$)}{$1} ){}
our $PLUGINSDIR = "$TOOLHOME/plugins";
our $CONFDIR = "$TOOLHOME/conf";

if( @ARGV < 3 ){
	print "usage: % $0 SERVICE VIRTUALHOST VSERVICE\n";
	exit 3;
}
my $service = $ARGV[0];
my $vhost = $ARGV[1];
my $vservice = $ARGV[2];

# setup work directory
our $WORKDIR;
if( $ENV{'HOME'} ){ $WORKDIR = $ENV{'HOME'} . "/.ncrt"; }
else{
	my ($name, $passwd, $uid, $gid, $quota, $comment, $gcos, $home, $shell, $expire ) = getpwuid $<;
	$WORKDIR = "$home/.ncrt";
}
unless( -d $WORKDIR ){ mkdir $WORKDIR or die "$WORKDIR: cannot create, stopped"; }

# metrics
my %m;

# read from service's output
open my $e, '-|', "$PLUGINSDIR/ncrtagentgateway_${service}_linux $CONFDIR $WORKDIR $vhost $vservice" or do {
	print "UNKNOWN $PLUGINSDIR/ncrtagentservice_${service}_linux: not found.\n";
	exit 3;
};
while( <$e> ){
	chomp;
	next if m"^\s*(#|$)";
	die "$_, stopped" unless m"^([-\w\./\[\]]+)=(\S+)$";
	my $k = $1;
	my $v = $2;
	$m{$k} = $v;
}
close $e;

my $plugin_has_failed;
my $plugin_rc = $? >> 8;
if( $plugin_rc > 0 ){
	$plugin_has_failed = 1;
}

#
my @p;
foreach my $k ( sort keys %m ){
	my $v = $m{$k};
	my $p = "$k=$v;;;;";
	push @p, $p;
}

#
my $r = 'OK';
my $rc = 0;
my @r;
if( $plugin_has_failed ){
	$r = 'UNKNOWN';
	$rc = 3;
	push @r, "$service plugin has failed.";
}

print join(' / ', $r, @r), "| ", join(' ', @p), "\n";
exit $rc;


