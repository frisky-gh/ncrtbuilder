#!/usr/bin/perl

use strict;

$0 =~ m"^(.*)/";
our $TOOLHOME = "$1/..";
while( $TOOLHOME =~ s{(^|/)[^\.][^/]*/\.\.(/|$)}{$1} ){}
our $PLUGINSDIR = "$TOOLHOME/plugins";
our $CONFDIR = "$TOOLHOME/conf";

sub var2ltsv ( \% ){
	my ($var) = @_;
	my @ltsv;
	push @ltsv, "timestamp:".$var->{timestamp} if defined $var->{timestamp};
	foreach my $k ( sort keys %$var ){
		next if $k eq 'timestamp';
		push @ltsv, "$k:".$var->{$k};
	}
	return join "\t", @ltsv;
}

#if( @ARGV < 2 ){
#	print "usage: % $0 DETECTOR_NAME TARGET_NAME [OPTION]\n";
#	exit 3;
#}
#my $detector = $ARGV[0];
#my $target = $ARGV[1];
#my $option = $ARGV[2];

# setup work directory
our $WORKDIR;
if( $ENV{'HOME'} ){ $WORKDIR = $ENV{'HOME'} . "/.ncrt"; }
else{
	my ($name, $passwd, $uid, $gid, $quota, $comment, $gcos, $home, $shell, $expire ) = getpwuid $<;
	$WORKDIR = "$home/.ncrt";
}
unless( -d $WORKDIR ){ mkdir $WORKDIR or die; }

#### load detector conf. for agents
my @notify_rules;
my $f = "$CONFDIR/ncrtmaster_notify.rules";
if( open my $h, '<', $f ){
	while( <$h> ){
		chomp;
		next if m"^\s*(#|$)";
		die "$f:$.:$_: illegal format, stopped" unless m"^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(notify|daily|weekly)$";
		my $host_re    = qr"^$1$";
		my $service_re = qr"^$2$";
		my $state_re   = qr"^$3$";
		my $address_re = qr"^$4$";
		my $action     = $5;
		push @notify_rules, [$host_re, $service_re, $state_re, $address_re, $action];
	}
	close $f;
}

####
my ($sec, $min, $hour, $day, $mon, $year) = localtime time;
my $now = sprintf "%04d-%02d-%02d_%02d:%02d:%02d", $year+1900, $mon+1, $day, $hour, $min, $sec;
my $target = $ARGV[0];
my @argv;
my %var = ('timestamp' => $now);
foreach my $a ( @ARGV[1..$#ARGV] ){
	push @argv, quotemeta $a;
	next unless $a =~ m"^(\w+)=(.*)$";
        $var{$1} = $2;
}

my $last_action;
foreach my $rule ( @notify_rules ){
	my ($host_re, $service_re, $state_re, $address_re, $action) = @$rule;
	next unless $var{HOSTNAME} =~ m"$host_re";
	next unless $var{SERVICEDESC} =~ m"$service_re";
	next unless $var{SERVICESTATE} =~ m"$state_re";
	next unless $target =~ m"$address_re";
	$last_action = $action;
}
if( $last_action eq 'notify' ){
	#
}elsif( $last_action eq 'daily' ){
	if( open my $h, '>>', "$WORKDIR/notify_daily.$target.log" ){
		print $h var2ltsv(%var), "\n";
		close $h;
	}
	exit 0;
}elsif( $last_action eq 'weekly' ){
	if( open my $h, '>>', "$WORKDIR/notify_weekly.$target.log" ){
		print $h var2ltsv(%var), "\n";
		close $h;
	}
	exit 0;
}else{
	exit 0;
}

####
if( open my $e, '>>', "$WORKDIR/notify.log" ){
	foreach my $a (@ARGV){
		print $e "$now ARGV $a\n";
	}
	while( my ($k, $v) = each %ENV ){
		print $e "$now ENV $k=$v\n";
	}
	close $e;
}

my @messenger_plugins;
opendir my $d, $PLUGINSDIR or die;
while( my $e = readdir $d ){
	next unless $e =~ m"^ncrtmaster(messenger)_";
        push @messenger_plugins, $e if $1;
}
closedir $d;
foreach my $plugin ( @messenger_plugins ){
	my $r = system "$PLUGINSDIR/$plugin $CONFDIR $WORKDIR @argv";
}

exit 0;

