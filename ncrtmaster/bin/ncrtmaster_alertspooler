#!/usr/bin/perl

use strict;

$0 =~ m"^(.*)/";
our $TOOLHOME = "$1/..";
while( $TOOLHOME =~ s{(^|/)[^\.][^/]*/\.\.(/|$)}{$1} ){}
our $PLUGINSDIR = "$TOOLHOME/plugins";
our $CONFDIR = "$TOOLHOME/conf";

sub var2ltsv ( \% ){
	my ($var) = @_;
	my @ltsv;
	push @ltsv, "timestamp:".$var->{timestamp} if defined $var->{timestamp};
	foreach my $k ( sort keys %$var ){
		next if $k eq 'timestamp';
		push @ltsv, "$k:".$var->{$k};
	}
	return join "\t", @ltsv;
}

####
if( @ARGV < 1 ){
	print "usage: % $0 RECIPIENT [VAR1=VALUE1] [VAR2=VALUE2] ...\n";
	print "    alertspooler divides naemon alerts among systems\n";
	print "    and spools the alerts as alertlog.\n";
	print "    Alerts spooled is treated by alertmessenger at later.\n";
	exit 3;
}

my ($sec, $min, $hour, $day, $mon, $year) = localtime time;
my $now = sprintf "%04d-%02d-%02d_%02d:%02d:%02d", $year+1900, $mon+1, $day, $hour, $min, $sec;
my $recipient = $ARGV[0];
my @argv;
my %var = ('timestamp' => $now);
foreach my $a ( @ARGV[1..$#ARGV] ){
	push @argv, quotemeta $a;
	next unless $a =~ m"^(\w+)=(.*)$";
        $var{$1} = $2;
}

# setup work directory
our $WORKDIR;
if( $ENV{'HOME'} ){ $WORKDIR = $ENV{'HOME'} . "/.ncrt"; }
else{
	my ($name, $passwd, $uid, $gid, $quota, $comment, $gcos, $home, $shell, $expire ) = getpwuid $<;
	$WORKDIR = "$home/.ncrt";
}
unless( -d $WORKDIR ){ mkdir $WORKDIR or die; }

#### load alertspooler conf.
my @divide_rules;
my $f = "$CONFDIR/ncrtmaster_alertspooler.rules";
if( open my $h, '<', $f ){
	while( <$h> ){
		chomp;
		next if m"^\s*(#|$)";
		die "$f:$.:$_: illegal format, stopped" unless m"^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(notify|daily|weekly)$";
		my $host_re    = qr"^$1$";
		my $service_re = qr"^$2$";
		my $state_re   = qr"^$3$";
		my $address_re = qr"^$4$";
		my $system     = $5;
		push @divide_rules, [$host_re, $service_re, $state_re, $address_re, $system];
	}
	close $f;
}

####
my $last_system;
foreach my $rule ( @divide_rules ){
	my ($host_re, $service_re, $state_re, $address_re, $system) = @$rule;
	next unless $var{HOSTNAME} =~ m"$host_re";
	next unless $var{SERVICEDESC} =~ m"$service_re";
	next unless $var{SERVICESTATE} =~ m"$state_re";
	next unless $recipient =~ m"$address_re";
	$last_system = $system;
}

####
if( open my $h, '>>', "$WORKDIR/alertlog.$last_system.$recipient.log" ){
	print $h var2ltsv(%var), "\n";
	close $h;
}
exit 0;

####
#if( open my $e, '>>', "$WORKDIR/notify.log" ){
#	foreach my $a (@ARGV){
#		print $e "$now ARGV $a\n";
#	}
#	while( my ($k, $v) = each %ENV ){
#		print $e "$now ENV $k=$v\n";
#	}
#	close $e;
#}

#my @messenger_plugins;
#opendir my $d, $PLUGINSDIR or die;
#while( my $e = readdir $d ){
#	next unless $e =~ m"^ncrtmaster(messenger)_";
#        push @messenger_plugins, $e if $1;
#}
#closedir $d;
#foreach my $plugin ( @messenger_plugins ){
#	my $r = system "$PLUGINSDIR/$plugin $CONFDIR $WORKDIR @argv";
#}
#
#exit 0;

